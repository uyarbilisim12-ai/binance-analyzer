<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>4H Trend Targets & TRAMA Pro Paneli</title>
<style>
    body{background:#0f1115;color:#eaeaea;font-family:Arial;margin:20px}
    h2{text-align:center;color:#00ffbb}
    
    .filter-container { 
        display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; align-items: center; 
        background: #1c2127; padding: 15px; border-radius: 8px; flex-wrap: wrap;
    }
    select { background: #2a2e35; color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }

    table{border-collapse:collapse;width:100%;font-size:12px;background:#161a1e}
    th,td{border:1px solid #333;padding:10px;text-align:center;vertical-align:middle}
    th{background:#1c2127;color:#aaa;text-transform:uppercase;font-size:10px; letter-spacing: 1px;}
    
    .long{color:#00ffbb;font-weight:bold}
    .short{color:#ff1100;font-weight:bold}
    .wait-text{color:#666; font-style: italic;}
    .active-row{color:#00bfff;font-weight:bold}
    .win{background:#005533;color:#fff;padding:2px 6px;border-radius:3px;font-weight:bold}
    .loss{background:#550000;color:#fff;padding:2px 6px;border-radius:3px;font-weight:bold}
    
    small{display:block;margin-top:4px;color:#888;font-size:10px}
    .status-box{padding:6px;border-radius:4px;background:rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05)}
</style>
</head>
<body>

<h2>ðŸ“Š 4H Trend Targets & TRAMA Profesyonel Takip</h2>

<div class="filter-container">
    <label>GÃ¶rÃ¼nÃ¼mÃ¼ Filtrele:</label>
    <select id="filterSelect" onchange="draw()">
        <option value="all">TÃœMÃœ (HEPSÄ°)</option>
        <option value="active">SADECE AKTÄ°F Ä°ÅžLEMLER</option>
        <option value="waiting">SADECE BEKLEYENLER</option>
        <option value="pos_long">SADECE LONG</option>
        <option value="pos_short">SADECE SHORT</option>
        <option value="trama_up">TREND: YÃœKSELEN (Trama ÃœstÃ¼)</option>
        <option value="trama_down">TREND: DÃœÅžEN (Trama AltÄ±)</option>
        <option value="win">SONUÃ‡: KAZANANLAR</option>
        <option value="loss">SONUÃ‡: KAYBEDENLER</option>
    </select>
</div>

<table>
<thead>
    <tr>
        <th>Coin</th>
        <th>AnlÄ±k Fiyat</th>
        <th>Trend YÃ¶nÃ¼</th>
        <th>Ä°ÅŸlem Durumu</th>
        <th>GiriÅŸ (Entry)</th>
        <th>TP1 / TP2</th>
        <th>Stop Loss</th>
        <th>PnL (%)</th>
        <th>SonuÃ§</th>
        <th>4H TRAMA (% Fark)</th>
        <th>EMA50 (% Fark)</th>
    </tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
/* ================= AYARLAR ================= */
const SYMBOLS = ["BTCUSDT","ETHUSDT","SOLUSDT","AVAXUSDT","BNBUSDT","XRPUSDT","LINKUSDT","ADAUSDT","DOTUSDT"];
const INTERVAL = "4h";
const ST_FACTOR = 12;
const ST_ATR_PERIOD = 90;
const WMA_LEN = 40;
const EMA_LEN_TREND = 14;
const VOL_ATR_PERIOD = 14;
const SL_MULT = 5;
const TP1_MULT = 0.5;
const TP2_MULT = 1.0;

let state = {};

/* ================= TEKNÄ°K FONKSÄ°YONLAR ================= */
function getATR(h, l, c, period, idx) {
    let trs = [];
    for (let i = Math.max(1, idx - period + 1); i <= idx; i++) {
        trs.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
    }
    return trs.length ? trs.reduce((a,b)=>a+b, 0) / trs.length : 0;
}

function calcWMA(series, len) {
    if(series.length < len) return series[series.length-1];
    let sum = 0, weight = 0;
    for (let i = 0; i < len; i++) {
        let w = len - i;
        sum += series[series.length - 1 - i] * w;
        weight += w;
    }
    return sum / weight;
}

// Senini paylaÅŸtÄ±ÄŸÄ±n ve doÄŸru Ã§alÄ±ÅŸan TRAMA kodu
function calculateTRAMA(closes, highs, lows, length = 99) {
    let ama = closes[0];
    let sig = new Array(closes.length).fill(0);
    for (let i = 1; i < closes.length; i++) {
        let hh = 0, ll = 0;
        if (i >= length) {
            const cH = Math.max(...highs.slice(i - length + 1, i + 1));
            const pH = Math.max(...highs.slice(i - length, i));
            const cL = Math.min(...lows.slice(i - length + 1, i + 1));
            const pL = Math.min(...lows.slice(i - length, i));
            hh = cH > pH ? 1 : 0; ll = cL < pL ? 1 : 0;
        }
        sig[i] = (hh || ll) ? 1 : 0;
        let sma = (i >= length) ? (sig.slice(i - length + 1, i + 1).reduce((a, b) => a + b, 0) / length) : 0;
        ama = ama + Math.pow(sma, 2) * (closes[i] - ama);
    }
    return ama;
}

/* ================= ANA VERÄ° MOTORU ================= */
async function processSymbol(symbol) {
    try {
        const r = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${INTERVAL}&limit=1000`);
        const candles = await r.json();
        const h = candles.map(x=>+x[2]), l = candles.map(x=>+x[3]), c = candles.map(x=>+x[4]), hl2 = h.map((v,i)=>(v+l[i])/2);

        // 1. AlgoAlpha Trend Ã‡izgisi (finalTL)
        let ubArr = [], lbArr = [], tlSeries = [];
        for(let i=0; i<c.length; i++){
            let atrVal = getATR(h, l, c, ST_ATR_PERIOD, i);
            let ub = hl2[i] + ST_FACTOR * atrVal, lb = hl2[i] - ST_FACTOR * atrVal;
            if(i>0){
                lb = (lb > lbArr[i-1] || c[i-1] < lbArr[i-1]) ? lb : lbArr[i-1];
                ub = (ub < ubArr[i-1] || c[i-1] > ubArr[i-1]) ? ub : ubArr[i-1];
            }
            ubArr.push(ub); lbArr.push(lb);
            tlSeries.push((lb+ub)/2);
        }
        let wmaSeries = [];
        for(let i=1; i<=tlSeries.length; i++) wmaSeries.push(calcWMA(tlSeries.slice(0,i), WMA_LEN));
        let k = 2/(EMA_LEN_TREND+1), finalTL = [wmaSeries[0]];
        for(let i=1; i<wmaSeries.length; i++) finalTL.push(wmaSeries[i]*k + finalTL[i-1]*(1-k));

        // 2. Sinyal Tespiti (Sadece son 100 muma bakar)
        let trend = 0, entryPrice = null, hasSignalIn100 = false, lastTrend = 0;
        const startCheckIdx = Math.max(1, finalTL.length - 100);
        for(let i=1; i<finalTL.length; i++) {
            let currentTrend = finalTL[i] > finalTL[i-1] ? 1 : -1;
            if(i >= startCheckIdx && currentTrend !== lastTrend && lastTrend !== 0) {
                hasSignalIn100 = true;
                entryPrice = c[i];
                trend = currentTrend;
            }
            lastTrend = currentTrend;
        }

        // 3. TRAMA & EMA50
        const tramaValue = calculateTRAMA(c, h, l, 99);
        let ek = 2/51, ema50 = c[0];
        for(let i=1; i<c.length; i++) ema50 = c[i]*ek + ema50*(1-ek);

        // 4. Hedefler (TP/SL)
        let tp1=null, tp2=null, sl=null;
        if(hasSignalIn100) {
            let vol = getATR(h, l, c, VOL_ATR_PERIOD, c.length-1);
            let slDist = vol * SL_MULT;
            sl = trend === 1 ? entryPrice - slDist : entryPrice + slDist;
            let diff = Math.abs(entryPrice - sl);
            tp1 = trend === 1 ? entryPrice + diff*TP1_MULT : entryPrice - diff*TP1_MULT;
            tp2 = trend === 1 ? entryPrice + diff*TP2_MULT : entryPrice - diff*TP2_MULT;
        }

        state[symbol] = {
            pos: hasSignalIn100 ? trend : 0,
            entry: entryPrice,
            lastPrice: c[c.length-1],
            tp1, tp2, sl, trama: tramaValue, ema50,
            status: hasSignalIn100 ? "active" : "waiting",
            result: null
        };
    } catch(e) { console.error(symbol, e); }
}

/* ================= TABLO Ã‡Ä°ZÄ°MÄ° ================= */
function draw() {
    const filter = document.getElementById("filterSelect").value;
    const tb = document.getElementById("rows");
    let h = "";
    for (const s of SYMBOLS) {
        const d = state[s]; if (!d) continue;
        
        // Filtre Uygulama
        if (filter === "active" && d.status !== "active") continue;
        if (filter === "waiting" && d.status !== "waiting") continue;
        if (filter === "pos_long" && d.pos !== 1) continue;
        if (filter === "pos_short" && d.pos !== -1) continue;
        if (filter === "trama_up" && d.lastPrice < d.trama) continue;
        if (filter === "trama_down" && d.lastPrice > d.trama) continue;
        if (filter === "win" && d.result !== "WIN") continue;
        if (filter === "loss" && d.result !== "LOSS") continue;

        const pnl = d.entry ? (d.pos === 1 ? ((d.lastPrice - d.entry)/d.entry)*100 : ((d.entry - d.lastPrice)/d.entry)*100) : 0;
        const tramaDiff = ((d.lastPrice - d.trama)/d.trama)*100;
        const emaDiff = ((d.ema50 - d.trama)/d.trama)*100;

        h += `<tr>
            <td style="font-weight:bold">${s}</td>
            <td style="font-size:13px">${d.lastPrice.toFixed(4)}</td>
            <td class="${d.pos === 1 ? 'long' : d.pos === -1 ? 'short' : ''}">${d.pos === 1 ? 'LONG â–²' : d.pos === -1 ? 'SHORT â–¼' : '-'}</td>
            <td class="${d.status === 'active' ? 'active-row' : 'wait-text'}">${d.status === 'active' ? 'Ä°ÅžLEMDE' : 'BEKLÄ°YOR'}</td>
            <td>${d.entry ? d.entry.toFixed(4) : '-'}</td>
            <td>${d.tp1 ? d.tp1.toFixed(4) + '<br>' + d.tp2.toFixed(4) : '-'}</td>
            <td>${d.sl ? d.sl.toFixed(4) : '-'}</td>
            <td class="${pnl >= 0 ? 'long' : 'short'}">${d.entry ? pnl.toFixed(2)+'%' : '-'}</td>
            <td>${d.result ? `<span class="${d.result === 'WIN' ? 'win' : 'loss'}">${d.result}</span>` : "-"}</td>
            <td><div class="status-box">${d.lastPrice > d.trama ? '<span class="long">ÃœstÃ¼nde</span>' : '<span class="short">AltÄ±nda</span>'} <small>(%${tramaDiff.toFixed(2)})</small><small>${d.trama.toFixed(6)}</small></div></td>
            <td><div class="status-box">${d.ema50 > d.trama ? '<span class="long">Ãœstte</span>' : '<span class="short">Altta</span>'} <small>(%${emaDiff.toFixed(2)})</small><small>${d.ema50.toFixed(6)}</small></div></td>
        </tr>`;
    }
    tb.innerHTML = h;
}

/* ================= BAÅžLATMA ================= */
async function init() {
    for (const s of SYMBOLS) await processSymbol(s);
    draw();
    
    // AnlÄ±k fiyat takibi (WebSocket)
    const ws = new WebSocket("wss://fstream.binance.com/ws/!markPrice@arr");
    ws.onmessage = e => {
        JSON.parse(e.data).forEach(t => {
            const s = state[t.s]; if(!s) return;
            s.lastPrice = Number(t.p);
            // SonuÃ§ kontrolÃ¼ (KÃ¢r al/Stop)
            if(s.status === "active" && !s.result) {
                if(s.pos === 1 && s.lastPrice >= s.tp2) s.result = "WIN";
                if(s.pos === 1 && s.lastPrice <= s.sl) s.result = "LOSS";
                if(s.pos === -1 && s.lastPrice <= s.tp2) s.result = "WIN";
                if(s.pos === -1 && s.lastPrice >= s.sl) s.result = "LOSS";
            }
        });
        draw();
    };
}
init();
</script>
</body>
</html>